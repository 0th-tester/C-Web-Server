# Least-Recently Used Cache (LRU Cache)

## 캐시(Caches)

캐시는 빠른 검색 및 조회를 위해 일반적으로 사용되는 정보의 사본을 저장하는 장소입니다.
데이터를 캐시에 저장하면 원래 소스에서 가져 오는 것보다 빠르다.

많은 사람들이이 데이터에 액세스하기를 원한다면 더 빠른 캐시에 넣으므로 보다 신속하게 얻을 수 있다.

CPU에는 일반적으로 사용되는 RAM 부분을 유지하는 캐시가 있어 CPU가 매번 느린 RAM을 기다릴 필요가 없다.

웹 브라우저는 웹 페이지 및 기타 웹 데이터의 캐시를 유지하므로 페이지를 이동할 때마다 네트워크를 통해 검색 할 필요가 없다. 크게 페이지로드 시간을 단축한다.

웹 서버는 파일을 캐싱 할 수 있으므로 운영 체제를 거칠 필요가 없기 때문에 매번 디스크에서 파일을 가져올 필요가 없고 단지 검색으로 할 수 있습니다. 파일을 RAM에서 직접 가져 와서 직접 제공한다.

## LRU 캐시(LRU Caches)

물론, _모든것_ 을 _영원히_ 캐시할 수는 없다.  원하는 경우 저장소에 저장하려는 모든 것만큼 큰 캐시가 필요합니다. 웹 서버는 몇 테라 바이트의 데이터에 액세스 할 수 있지만 몇 기가 바이트의 RAM 만 가질 수 있다.
 
그래서 택해야 한다. 제한된 크기의 캐시를 가지고 가장 자주 액세스하는 데이터로 캐시를 채우는 것이 좋다. 

이러한 전략 중 하나는 _LRU 캐시_ 이다. LRU 캐시 유형은 고정 된 수의 항목(또는 크기 (바이트))을 갖는다. 

웹 서버의 컨텍스트에서 클라이언트가 파일이 요청하면 다음 과정이 발생한다.:

1. 캐시 안에 파일이 있는 지 확인한다.
1. Check if the file is in the cache.

2. 있다면 전달한다.
2. If it is, serve it. We're done.

3. 없으면 디스크에서 파일을 로딩한다.
3. If it's not in the cache, load it from disk.

4. 캐시에 파일을 저장한다.
4. Save it in the cache.

5. 전달한다.
5. Serve it.

캐시가 최대 크기를 초과하면 _Least recently used_ 에 의해 캐시에서 삭제한다.

## LRU 캐시 만드는 법 

### 구조

LRU 캐시는 두개의 자료 구조로 구성되어 있다. : 이중 연결 리스트와 해시 테이블

* 해시 테이블은 이중 연결 리스트에서 빠른 검색을 위해 사용된다.

* 이중 연결 리스트는 최근 사용된 요소를 추적하기 위해 사용된다. 
  
리스트의 맨 앞은 가장 최근 사용된 아이템이다.

맨 끝은 가장 적게 사용된 아이템이다. 

### 캐시에 아이템 넣기

아이템은 키에 의해 식별된다. (웹 서버의 경우 키는 디스크의 경로가 문제의 파일에 포함 된 문자열이어야합니다).


_ 캐시 엔트리(cache entry) _에는 캐시에서 검색된 파일을 다시 제공하는 데 필요한 모든 정보의 사본이 들어 있다.
웹 서버의 경우 이것은 내용 MIME 유형, 내용 길이 및 내용 자체와 유사합니다.

캐시 항목은 `prev`와 `next` 가져야 한다. 이중 연결 리스트를 이용하기 위함이다.

마지막으로 키의 복사본을 포함해야한다.

캐시에 아이템을 넣기 위해선 :

1. 모든 필수 정보를 포함하는 새로운 캐시 엔트리을 생성한다.

2. 캐시 항목에 대한 포인터를 이중 연결 리스트의 헤드에 추가한다.

3. 키로 인덱스를 가지는 해시 테이블에 캐시 엔트리를 추가한다.

4. 캐시가 최대 크기를 초과하면 [LRU에서 아이템 삭재](#LRU에서-아이템-삭재)를 참고해라.

### 캐시에서 아이템 얻기

1. 키가 있는 해시 테이블에 캐시 엔트리를 찾는다.

2. 해시 테이블에 없다면 캐시 안에 없는 것이다.

3. 해시 테이블에서 찾았다면 캐시 엔트리는 이중 연결 리스트에서 제거된다.

4. 캐시 엔트리는 이중 연결 리스트의 헤드에 삽입된다. (가장 최근에 사용된 것이기 때문)


캐시에서 항목을 가져올 때마다 목록 맨 앞으로 이동하므로 가장 최근에 사용된다.

이런 식으로 자주 사용되는 항목은 목록의 맨 위로 올라가는 경향이 있으며 자주 사용되지 않는 항목은 목록의 끝에 오게 된다.

### LRU에서 아이템 삭재

캐시가 허용된 최대 크기를 초과할 경우, 사용한지 가장 오래된 아이템을 버려야 한다.

일반적으로 항목을 초과하는 크기로 리스트에 항목을 삽입 할 때 발생한다.

* while size > max_size:
  * 리스트의 끝에 캐시 엔트리를 가져온다.
  * 가져온 캐시 엔트리를 삭제한다.
  * 해당 키를 사용하여 해시 테이블에서 제거한다.